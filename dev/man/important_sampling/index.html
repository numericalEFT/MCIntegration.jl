<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Important Sampling · MCIntegration.jl</title><script data-outdated-warner src="../../assets/warner.js"></script><link rel="canonical" href="https://numericaleft.github.io/MCIntegration.jl/man/important_sampling/"/><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.039/juliamono-regular.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.11/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../assets/documenter.js"></script><script src="../../siteinfo.js"></script><script src="../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../">MCIntegration.jl</a></span></div><form class="docs-search" action="../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../">Home</a></li><li><span class="tocitem">Manual</span><ul><li class="is-active"><a class="tocitem" href>Important Sampling</a><ul class="internal"><li><a class="tocitem" href="#Introduction"><span>Introduction</span></a></li><li><a class="tocitem" href="#Approach-1:-Algorithm-with-a-Normalization-Sector"><span>Approach 1: Algorithm with a Normalization Sector</span></a></li><li><a class="tocitem" href="#Approach-2:-Conventional-algorithm-(e.g.,-Vegas-algorithm)"><span>Approach 2: Conventional algorithm (e.g., Vegas algorithm)</span></a></li><li><a class="tocitem" href="#Benchmark"><span>Benchmark</span></a></li></ul></li></ul></li><li><span class="tocitem">Library</span><ul><li><a class="tocitem" href="../../lib/montecarlo/">Monte Carlo</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Manual</a></li><li class="is-active"><a href>Important Sampling</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Important Sampling</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/numericaleft/MCIntegration.jl/blob/master/docs/src/man/important_sampling.md#" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Important-Sampling"><a class="docs-heading-anchor" href="#Important-Sampling">Important Sampling</a><a id="Important-Sampling-1"></a><a class="docs-heading-anchor-permalink" href="#Important-Sampling" title="Permalink"></a></h1><h2 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h2><p>This note compares two important sampling approaches for Monte Carlo integration. The first approach introduces a normalization sector and lets the Markov chain jumps between this additional sector and the integrand sector following a calibrated probability density for important sampling. One can infer the integration between the ratio of weights between two sectors. On the other hand, the second approach reweights the original integrand to make it as flat as possible, one then perform a random walk uniformly in the parameter space to calculate the integration. This is the conventional approach used in Vegas algorithm.</p><p>In general, the first approach is more robust than the second one, but less efficient. In many applications, for example, high order Feynman diagrams with a sign alternation, the important sampling probability can&#39;t represent the complicated integrand well. Then the first approach is as efficient as the second one, but tends to be much robust.</p><p>We next present a benchmark between two approaches. Consider the MC sampling of an one-dimensional functions <span>$f(x)$</span> (its sign may oscillate).</p><p>We want to design an efficient algorithm to calculate the integral <span>$\int_a^b dx f(x)$</span>. To do that, we normalize the integrand with an ansatz <span>$g(x)&gt;0$</span> to reduce the variant. </p><p>Our package supports two important sampling schemes. </p><h2 id="Approach-1:-Algorithm-with-a-Normalization-Sector"><a class="docs-heading-anchor" href="#Approach-1:-Algorithm-with-a-Normalization-Sector">Approach 1: Algorithm with a Normalization Sector</a><a id="Approach-1:-Algorithm-with-a-Normalization-Sector-1"></a><a class="docs-heading-anchor-permalink" href="#Approach-1:-Algorithm-with-a-Normalization-Sector" title="Permalink"></a></h2><p>In this approach, the configuration spaces consist of two sub-spaces: the physical sector with orders <span>$n\ge 1$</span> and the normalization sector with the order <span>$n=0$</span>. The weight function of the latter, <span>$g({x})$</span>, should be simple enough so that the integral <span>$G=\int g({x}) d x$</span> is explicitly known. In our algorithm we use a constant <span>$g(x) \propto 1$</span> for simplicity. In this setup, the physical sector weight, namely the integral <span>$F = \int f(x) d{x}$</span>, can be calculated with the equation</p><p class="math-container">\[    F=\frac{F_{\rm MC}}{G_{\rm MC}} G\]</p><p>where the MC estimators <span>$F_{\rm MC}$</span> and <span>$G_{\rm MC}$</span> are measured with </p><p class="math-container">\[F_{\rm MC} =\frac{1}{N} \left[ \sum_{i=1}^{N_f} \frac{f(x_i)}{\rho_f(x_i)} + \sum_{i=1}^{N_g} 0 \right]\]</p><p>and</p><p class="math-container">\[G_{\rm MC} =\frac{1}{N} \left[\sum_{i=1}^{N_f} 0 + \sum_{i=1}^{N_g} \frac{g(x_i)}{\rho_g(x_i)}  \right]\]</p><p>The probability density of a given configuration is proportional to <span>$\rho_{f}(x)=|f(x)|$</span> and <span>$\rho_{g}(x)=|g(x)|$</span>, respectively. After <span>$N$</span> MC updates, the physical sector is sampled for <span>$N_f$</span> times, and the normalization sector is for <span>$N_g$</span> times. </p><p>Now we estimate the statistic error. According to the propagation of uncertainty, the variance of <span>$F$</span>  is given by</p><p class="math-container">\[ \frac{\sigma^2_F}{F^2} =  \frac{\sigma_{F_{\rm MC}}^2}{F_{MC}^2} + \frac{\sigma_{G_{\rm MC}}^2}{G_{MC}^2}, \]</p><p>where <span>$\sigma_{F_{\rm MC}}$</span> and <span>$\sigma_{G_{\rm MC}}$</span> are variance of the MC integration <span>$F_{\rm MC}$</span> and <span>$G_{\rm MC}$</span>, respectively. In the Markov chain MC, the variance of <span>$F_{\rm MC}$</span> can be written as </p><p class="math-container">\[\sigma^2_{F_{\rm MC}} = \frac{1}{N} \left[ \sum_{i}^{N_f} \left( \frac{f(x_i)}{\rho_f(x_i)}- \frac{F}{Z}\right)^2 +\sum_{j}^{N_g} \left(0-\frac{F}{Z} \right)^2  \right] \]</p><p class="math-container">\[= \int \left( \frac{f(x)}{\rho_f(x)} - \frac{F}{Z} \right)^2 \frac{\rho_f(x)}{Z} {\rm d}x + \int \left( \frac{F}{Z} \right)^2 \frac{\rho_g(x)}{Z} dx \]</p><p class="math-container">\[=  \int \frac{f^2(x)}{\rho_f(x)} \frac{dx}{Z} -\frac{F^2}{Z^2} \]</p><p>Here <span>$Z=Z_f+Z_g$</span> and <span>$Z_{f/g}=\int \rho_{f/g}({x})d{x}$</span> are the partition sums of the corresponding configuration spaces. Due to the detailed balance, one has <span>$Z_f/Z_g=N_f/N_g$</span>.  </p><p>Similarly, the variance of <span>$G_{\rm MC}$</span> can be written as </p><p class="math-container">\[\sigma^2_{G_{\rm MC}}=  \int \frac{g^2(x)}{\rho_g(x)} \frac{dx}{Z} - \frac{G^2}{Z^2}\]</p><p>By substituting <span>$\rho_{f}(x)=|f(x)|$</span> and  <span>$\rho_{g}(x)=|g(x)|$</span>, the variances of <span>$F_{\rm MC}$</span> and <span>$G_{\rm MC}$</span> are given by</p><p class="math-container">\[\sigma^2_{F_{\rm MC}}= \frac{1}{Z^2} \left( Z Z_f - F^2 \right)\]</p><p class="math-container">\[\sigma^2_{G_{\rm MC}}= \frac{1}{Z^2} \left( Z Z_g - G^2 \right)\]</p><p>We derive the variance of <span>$F$</span> as</p><p class="math-container">\[\frac{\sigma^2_F}{F^2} = \frac{Z \cdot Z_f}{F^2}+\frac{Z \cdot Z_g}{G^2} - 2 \]</p><p>Note that <span>$g(x)&gt;0$</span> indicates <span>$Z_g = G$</span>,  so that</p><p class="math-container">\[\frac{\sigma^2_F}{F^2} = \frac{Z_f^2}{F^2}+\frac{G\cdot Z_f}{F^2}+\frac{Z_f}{G} - 1\]</p><p>Interestingly, this variance is a function of <span>$G$</span> instead of a functional of <span>$g(x)$</span>. It is then possible to normalized <span>$g(x)$</span> with a constant to minimize the variance. The optimal constant makes <span>$G$</span> to be,</p><p class="math-container">\[\frac{d \sigma^2_F}{dG}=0,\]</p><p>which makes <span>$G_{best} = |F|$</span>. The minimized the variance is given by,</p><p class="math-container">\[\frac{\sigma^2_F}{F^2}= \left(\frac{Z_f}{F}+1\right)^2 - 2\ge 0.\]</p><p>The equal sign is achieved when <span>$f(x)&gt;0$</span> is positively defined.</p><p><strong>It is very important that the above analysis is based on the assumption that the autocorrelation time negligible. The autocorrelation time related to the jump between the normalization and physical sectors is controlled by the deviation of the ratio <span>$|f(x)|/g(x)$</span> from unity. The variance <span>$\sigma_F^2$</span> given above will be amplified to <span>$\sim \sigma_F^2 \tau$</span> where <span>$\tau$</span> is the autocorrelation time.</strong></p><h2 id="Approach-2:-Conventional-algorithm-(e.g.,-Vegas-algorithm)"><a class="docs-heading-anchor" href="#Approach-2:-Conventional-algorithm-(e.g.,-Vegas-algorithm)">Approach 2: Conventional algorithm (e.g., Vegas algorithm)</a><a id="Approach-2:-Conventional-algorithm-(e.g.,-Vegas-algorithm)-1"></a><a class="docs-heading-anchor-permalink" href="#Approach-2:-Conventional-algorithm-(e.g.,-Vegas-algorithm)" title="Permalink"></a></h2><p>Important sampling is actually more straightforward than the above approach. One simply sample <span>$x$</span> with a distribution <span>$\rho_g(x)=g(x)/Z_g$</span>, then measure the observable <span>$f(x)/g(x)$</span>. Therefore, the mean estimation,</p><p class="math-container">\[\frac{F}{Z}=\int dx \frac{f(x)}{g(x)} \rho_g(x)\]</p><p>the variance of <span>$F$</span> in this approach is given by,</p><p class="math-container">\[\sigma_F^2=Z_g^2\int dx \left( \frac{f(x)}{g(x)}- \frac{F}{Z_g}\right)^2\rho_g(x)\]</p><p class="math-container">\[\frac{\sigma_F^2}{F^2}=\frac{Z_g}{F^2}\int dx \frac{|f(x)|^2}{|g(x)|}- 1\]</p><p>The optimal <span>$g(x)$</span> that minimizes the variance is <span>$g(x) =|f(x)|$</span>,</p><p class="math-container">\[\frac{\sigma_F^2}{F^2}=\frac{Z_f^2}{F^2}-1\]</p><ul><li>The variance of the conventional approach is a functional of <span>$g(x)$</span>, while that of the previous approach isn&#39;t. There are two interesting limit:</li><li>If the <span>$f(x)&gt;0$</span>, the optimal choice <span>$g(x)=|f(x)|$</span> leads to zero variance. In this limit, the conventional approach is clearly much better than the previous approach.</li><li>On the other hand, if <span>$g(x)$</span> is far from the optimal choice <span>$|f(x)|$</span>, say simply setting <span>$g(x)=1$</span>, one naively expect that the the conventional approach may leads to much larger variance than the previous approach. <strong>However,  this statement may not be true. If <span>$g(x)$</span> is very different from <span>$f(x)$</span>, the normalization and the physical sector in the previous approach mismatch, causing large autocorrelation time and large statistical error . In contrast, the conventional approach doesn&#39;t have this problem.</strong></li></ul><h2 id="Benchmark"><a class="docs-heading-anchor" href="#Benchmark">Benchmark</a><a id="Benchmark-1"></a><a class="docs-heading-anchor-permalink" href="#Benchmark" title="Permalink"></a></h2><ul><li>To benchmark, we sample the following integral up to <span>$10^8$</span> updates, </li></ul><p class="math-container">\[\int_0^\beta e^{-(x-\beta/2)^2/\delta^2}dx \approx \sqrt{\pi}\delta\]</p><p>where <span>$\beta \gg \delta$</span>.</p><ol><li><span>$g(x)=|f(x)|$</span></li></ol><ul><li><strong>Normalization Sector</strong>:  <strong>doesn&#39;t</strong> lead to exact result, the variance <span>$\left(\frac{Z_f}{F}+1\right)^2 - 2=2$</span> doesn&#39;t change with parameters</li></ul><table><tr><th style="text-align: right"><span>$\beta$</span></th><th style="text-align: right">10</th><th style="text-align: right">100</th></tr><tr><td style="text-align: right">result</td><td style="text-align: right">0.1771(1)</td><td style="text-align: right">0.1773(1)</td></tr></table><ul><li><strong>Conventional</strong>: exact result</li></ul><ol><li><span>$g(x)=\sqrt{\pi}\delta/\beta1$</span></li></ol><table><tr><th style="text-align: right"><span>$\beta$</span></th><th style="text-align: right">10</th><th style="text-align: right">100</th></tr><tr><td style="text-align: right">Normalization</td><td style="text-align: right">0.1772(4)</td><td style="text-align: right">0.1767(17)</td></tr><tr><td style="text-align: right">Conventional</td><td style="text-align: right">0.1777(3)</td><td style="text-align: right">0.1767(8)</td></tr></table><ol><li><span>$g(x)=exp(-(x-\beta/2+s)^2/\delta^2)$</span> with <span>$\beta=100$</span></li></ol><table><tr><th style="text-align: right"><span>$s$</span></th><th style="text-align: right"><span>$\delta$</span></th><th style="text-align: right"><span>$2\delta$</span></th><th style="text-align: right"><span>$3\delta$</span></th><th style="text-align: right"><span>$4\delta$</span></th><th style="text-align: right"><span>$5\delta$</span></th></tr><tr><td style="text-align: right">Normalization</td><td style="text-align: right">0.1775(8)</td><td style="text-align: right">0.1767(25)</td><td style="text-align: right">0.1770(60)</td><td style="text-align: right">0.176(15)</td><td style="text-align: right">183(143)</td></tr><tr><td style="text-align: right">Conventional</td><td style="text-align: right">0.1776(5)</td><td style="text-align: right">0.1707(39)</td><td style="text-align: right">0.1243(174)</td><td style="text-align: right">0.0204 (64)</td><td style="text-align: right"></td></tr></table><p>The conventional algorithm is not ergodic anymore for <span>$s=4\delta$</span>, the acceptance ratio to update <span>$x$</span> is about <span>$0.15%$</span>, while the normalization algorithm becomes non ergodic for <span>$s=5\delta$</span>. So the latter is slightly more stable.</p><p>&lt;!– The code are ![[test.jl]] for the normalization approach and ![[test2.jl]] for the conventional approach. –&gt;</p><p><strong>Reference</strong>:  [1] Wang, B.Z., Hou, P.C., Deng, Y., Haule, K. and Chen, K., Fermionic sign structure of high-order Feynman diagrams in a many-fermion system. Physical Review B, 103, 115141 (2021).</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../">« Home</a><a class="docs-footer-nextpage" href="../../lib/montecarlo/">Monte Carlo »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.5 on <span class="colophon-date" title="Saturday 16 July 2022 01:13">Saturday 16 July 2022</span>. Using Julia version 1.7.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
